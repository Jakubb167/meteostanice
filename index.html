<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteostanice - Live Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            animation: fadeIn 0.8s;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 15px;
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .last-update {
            text-align: center;
            color: #666;
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 30px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 360px;
            display: flex;
            flex-direction: column;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 3.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            line-height: 1.1;
        }

        .stat-timestamp {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 10px;
            font-style: italic;
        }

        .stat-meta {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
        }

        .stat-trend {
            font-size: 0.95em;
            font-weight: 600;
            margin: 8px 0;
        }

        .stat-trend.up {
            color: #28a745;
        }

        .stat-trend.down {
            color: #dc3545;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters label {
            font-weight: 600;
            color: #667eea;
        }

        .filters select, .filters input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .chart-container:hover {
            transform: translateY(-5px);
        }

        .chart-container h2 {
            margin-bottom: 20px;
            color: #667eea;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .table-container h2 {
            margin-bottom: 20px;
            color: #667eea;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tbody tr:hover {
            background: #f5f5f5;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .heatmap-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .heatmap-wrapper {
            position: relative;
            width: 100%;
            overflow-x: visible;
            overflow-y: visible;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 0;
            width: 100%;
        }

        .heatmap-y-labels {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .heatmap-y-label {
            font-size: 0.7em;
            color: #666;
            text-align: right;
            padding-right: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 20px;
            line-height: 20px;
        }

        .heatmap-content-wrapper {
            display: flex;
            flex-direction: column;
        }

        .heatmap-x-labels {
            display: flex;
            height: 30px;
            position: relative;
            border-bottom: 1px solid #ddd;
            margin-bottom: 0;
        }

        .heatmap-month-label {
            position: absolute;
            font-size: 0.75em;
            color: #666;
            font-weight: 600;
            transform: translateX(-50%);
            top: 8px;
        }

        .heatmap-data {
            display: flex;
            gap: 0;
        }

        .heatmap-day-column {
            display: flex;
            flex-direction: column;
            gap: 0;
            flex: 1;
            min-width: 2px;
        }

        .heatmap-hour-cell {
            height: 20px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .heatmap-hour-cell:hover {
            transform: scale(1.5);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            border: 2px solid white;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .heatmap-legend-gradient {
            flex: 1;
            height: 25px;
            border-radius: 5px;
            background: linear-gradient(to right, 
                #1a2a4a,
                #3c5c8c,
                #6b9bc4,
                #a8cde3,
                #f5dc78,
                #faa04a,
                #e8583a,
                #c83028,
                #8b0000
            );
        }

        .chart-slider-container {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .chart-slider {
            position: relative;
            height: 60px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: visible;
            cursor: pointer;
            user-select: none;
        }

        .chart-slider-preview {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            pointer-events: none;
        }

        .chart-slider-window {
            position: absolute;
            height: 100%;
            background: rgba(102, 126, 234, 0.3);
            border: 2px solid #667eea;
            border-radius: 4px;
            cursor: move;
            min-width: 50px;
            box-sizing: border-box;
        }

        .chart-slider-handle {
            position: absolute;
            top: 0;
            width: 12px;
            height: 100%;
            background: #667eea;
            cursor: ew-resize;
            z-index: 10;
            box-sizing: border-box;
        }

        .chart-slider-handle.left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }

        .chart-slider-handle.right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8em;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.5em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-controls button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .chart-controls button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .chart-grid { grid-template-columns: 1fr; }
            .stats-grid { 
                grid-template-columns: 1fr;
            }
            .stat-value { font-size: 2.8em; }
            .stat-card { min-height: 320px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚õÖ Meteostanice - S√°zava</h1>
            <p class="subtitle">S√°zava - ƒåern√© Budy</p>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE DATA</span>
            </div>
        </header>

        <div id="lastUpdate" class="last-update"></div>
        <div id="loading" class="loading">‚è≥ Naƒç√≠t√°m data...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div class="stats-grid" id="statsGrid" style="display: none;"></div>

        <div class="tabs" id="tabs" style="display: none;">
            <button class="tab active" onclick="switchTab('current')">üìä Aktu√°lnƒõ</button>
            <button class="tab" onclick="switchTab('daily')">üìÖ Denn√≠</button>
            <button class="tab" onclick="switchTab('monthly')">üìÜ Mƒõs√≠ƒçn√≠</button>
            <button class="tab" onclick="switchTab('yearly')">üìã Roƒçn√≠</button>
        </div>

        <div id="currentTab" class="tab-content active">
            <div class="filters" id="currentFilters" style="display: none;">
                <div class="filter-group">
                    <label>üìÖ Obdob√≠:</label>
                    <select id="currentTimeRange" onchange="updateCurrentData()">
                        <option value="1">Posledn√≠ den</option>
                        <option value="3">Posledn√≠ 3 dny</option>
                        <option value="7" selected>Posledn√≠ch 7 dn√≠</option>
                        <option value="14">Posledn√≠ch 14 dn√≠</option>
                        <option value="30">Posledn√≠ch 30 dn√≠</option>
                        <option value="all">V≈°echna data</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Od:</label>
                    <input type="datetime-local" id="currentDateFrom" onchange="updateCurrentData()">
                </div>
                
                <div class="filter-group">
                    <label>Do:</label>
                    <input type="datetime-local" id="currentDateTo" onchange="updateCurrentData()">
                </div>

                <button class="btn" onclick="loadData()" style="margin-left: auto;">
                    üîÑ Obnovit data
                </button>
            </div>

            <div class="chart-grid" id="chartsGrid" style="display: none;">
                <div class="chart-container">
                    <h2>üå°Ô∏è Teplota v ƒçase</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('temp')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('temp')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('temp')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="tempChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="tempSlider">
                            <canvas class="chart-slider-preview" id="tempSliderPreview"></canvas>
                            <div class="chart-slider-window" id="tempSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="tempSliderStart">-</span>
                            <span id="tempSliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üíß Vlhkost v ƒçase</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('humidity')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('humidity')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('humidity')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="humidityChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="humiditySlider">
                            <canvas class="chart-slider-preview" id="humiditySliderPreview"></canvas>
                            <div class="chart-slider-window" id="humiditySliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="humiditySliderStart">-</span>
                            <span id="humiditySliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üå°Ô∏è Atmosf√©rick√Ω tlak</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('pressure')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('pressure')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('pressure')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="pressureChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="pressureSlider">
                            <canvas class="chart-slider-preview" id="pressureSliderPreview"></canvas>
                            <div class="chart-slider-window" id="pressureSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="pressureSliderStart">-</span>
                            <span id="pressureSliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üîã Napƒõt√≠ baterie meteostanice</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('battery')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('battery')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('battery')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="batteryChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="batterySlider">
                            <canvas class="chart-slider-preview" id="batterySliderPreview"></canvas>
                            <div class="chart-slider-window" id="batterySliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="batterySliderStart">-</span>
                            <span id="batterySliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üåßÔ∏è Sr√°≈æky</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('rain')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('rain')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('rain')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="rainChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="rainSlider">
                            <canvas class="chart-slider-preview" id="rainSliderPreview"></canvas>
                            <div class="chart-slider-window" id="rainSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="rainSliderStart">-</span>
                            <span id="rainSliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üîã Napƒõt√≠ baterie sr√°≈ækomƒõru</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('rainBattery')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('rainBattery')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('rainBattery')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="rainBatteryChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="rainBatterySlider">
                            <canvas class="chart-slider-preview" id="rainBatterySliderPreview"></canvas>
                            <div class="chart-slider-window" id="rainBatterySliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="rainBatterySliderStart">-</span>
                            <span id="rainBatterySliderEnd">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-container full-width" id="multiChart" style="display: none;">
                <h2>üìä Teplota & Vlhkost (2 osy Y)</h2>
                <div class="chart-controls">
                    <button onclick="resetZoom('all')">‚Ü∫ Reset zoom</button>
                    <button onclick="zoomIn('all')">üîç+ P≈ôibl√≠≈æit</button>
                    <button onclick="zoomOut('all')">üîç- Odd√°lit</button>
                </div>
                <div class="chart-wrapper" style="height: 450px;">
                    <canvas id="allParamsChart"></canvas>
                </div>
                <div class="chart-slider-container">
                    <div class="chart-slider" id="allSlider">
                        <canvas class="chart-slider-preview" id="allSliderPreview"></canvas>
                        <div class="chart-slider-window" id="allSliderWindow">
                            <div class="chart-slider-handle left"></div>
                            <div class="chart-slider-handle right"></div>
                        </div>
                    </div>
                    <div class="slider-labels">
                        <span id="allSliderStart">-</span>
                        <span id="allSliderEnd">-</span>
                    </div>
                </div>
            </div>

            <div class="chart-container full-width" id="quadChart" style="display: none;">
                <h2>üìà V≈°echny metriky meteostanice</h2>
                <p style="color: #666; margin-bottom: 10px; font-size: 0.9em;">Teplota (ƒçerven√°, vlevo) ‚Ä¢ Vlhkost (modr√°, vpravo) ‚Ä¢ Tlak (tyrkysov√°, vlevo) ‚Ä¢ Baterie (≈ælut√°, vpravo)</p>
                <div class="chart-controls">
                    <button onclick="resetZoom('quad')">‚Ü∫ Reset zoom</button>
                    <button onclick="zoomIn('quad')">üîç+ P≈ôibl√≠≈æit</button>
                    <button onclick="zoomOut('quad')">üîç- Odd√°lit</button>
                </div>
                <div class="chart-wrapper" style="height: 500px;">
                    <canvas id="quadAxisChart"></canvas>
                </div>
                <div class="chart-slider-container">
                    <div class="chart-slider" id="quadSlider">
                        <canvas class="chart-slider-preview" id="quadSliderPreview"></canvas>
                        <div class="chart-slider-window" id="quadSliderWindow">
                            <div class="chart-slider-handle left"></div>
                            <div class="chart-slider-handle right"></div>
                        </div>
                    </div>
                    <div class="slider-labels">
                        <span id="quadSliderStart">-</span>
                        <span id="quadSliderEnd">-</span>
                    </div>
                </div>
            </div>

            <div class="heatmap-container" id="heatmapContainer" style="display: none;">
                <h2>üî• Roƒçn√≠ heatmapa</h2>
                <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="filter-group">
                        <label>üìÖ Rok:</label>
                        <select id="heatmapYear" onchange="updateHeatmapMetric()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; font-size: 0.95em;">
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>üìä Zobrazit:</label>
                        <select id="heatmapMetric" onchange="updateHeatmapMetric()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; font-size: 0.95em;">
                            <option value="teplota">Teplota</option>
                            <option value="vlhkost">Vlhkost</option>
                            <option value="tlak">Tlak</option>
                            <option value="srazky">Sr√°≈æky</option>
                        </select>
                    </div>
                </div>
                <p style="color: #666; margin-bottom: 15px;" id="heatmapDescription">Pr≈Ømƒõrn√° teplota podle dne v roce a hodiny</p>
                <div class="heatmap-wrapper">
                    <div id="heatmapGrid"></div>
                </div>
                <div class="heatmap-legend">
                    <span style="font-size: 0.85em; color: #666; font-weight: 600;" id="heatmapLegendLabel">Teplota:</span>
                    <span style="font-size: 0.85em; color: #666;" id="heatmapMin">0¬∞C</span>
                    <div class="heatmap-legend-gradient" id="heatmapGradient"></div>
                    <span style="font-size: 0.85em; color: #666;" id="heatmapMax">30¬∞C</span>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container" id="distributionChart" style="display: none;">
                    <h2>üìä Distribuce teplot</h2>
                    <div class="chart-wrapper">
                        <canvas id="distributionCanvas"></canvas>
                    </div>
                </div>

                <div class="chart-container" id="scatterChart" style="display: none;">
                    <h2>üéØ Korelace: Teplota vs Vlhkost</h2>
                    <div class="chart-wrapper">
                        <canvas id="scatterCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="dailyTab" class="tab-content">
            <div class="filters" id="dailyFilters" style="display: flex;">
                <div class="filter-group">
                    <label>üìÖ Obdob√≠:</label>
                    <select id="dailyTimeRange" onchange="updateDailyData()">
                        <option value="7">Posledn√≠ch 7 dn√≠</option>
                        <option value="14">Posledn√≠ch 14 dn√≠</option>
                        <option value="30" selected>Posledn√≠ch 30 dn√≠</option>
                        <option value="60">Posledn√≠ch 60 dn√≠</option>
                        <option value="90">Posledn√≠ch 90 dn√≠</option>
                        <option value="all">V≈°echna data</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Od:</label>
                    <input type="date" id="dailyDateFrom" onchange="updateDailyData()">
                </div>
                
                <div class="filter-group">
                    <label>Do:</label>
                    <input type="date" id="dailyDateTo" onchange="updateDailyData()">
                </div>
            </div>

            <div class="chart-grid" style="display: grid;">
                <div class="chart-container">
                    <h2>üå°Ô∏è Denn√≠ teploty</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√°, minim√°ln√≠ a maxim√°ln√≠ teplota za den</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('dailyTemp')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('dailyTemp')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('dailyTemp')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dailyTempChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üíß Denn√≠ vlhkost</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√°, minim√°ln√≠ a maxim√°ln√≠ vlhkost za den</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('dailyHumidity')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('dailyHumidity')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('dailyHumidity')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dailyHumidityChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üå°Ô∏è Denn√≠ atmosf√©rick√Ω tlak</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√Ω, minim√°ln√≠ a maxim√°ln√≠ tlak za den</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('dailyPressure')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('dailyPressure')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('dailyPressure')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dailyPressureChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üåßÔ∏è Denn√≠ sr√°≈æky</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">√öhrn sr√°≈æek za den</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('dailyRain')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('dailyRain')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('dailyRain')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dailyRainChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <h2>üå°Ô∏è Tabulka teplot</h2>
                <table class="data-table" id="tempTable">
                    <thead>
                        <tr>
                            <th>Den</th>
                            <th>Pr≈Ømƒõr</th>
                            <th>Minimum</th>
                            <th>Maximum</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="table-container">
                <h2>üíß Tabulka vlhkosti</h2>
                <table class="data-table" id="humidityTable">
                    <thead>
                        <tr>
                            <th>Den</th>
                            <th>Pr≈Ømƒõr</th>
                            <th>Minimum</th>
                            <th>Maximum</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="table-container">
                <h2>üå°Ô∏è Tabulka tlaku</h2>
                <table class="data-table" id="pressureTable">
                    <thead>
                        <tr>
                            <th>Den</th>
                            <th>Pr≈Ømƒõr</th>
                            <th>Minimum</th>
                            <th>Maximum</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="table-container">
                <h2>üåßÔ∏è Tabulka sr√°≈æek</h2>
                <table class="data-table" id="rainTable">
                    <thead>
                        <tr>
                            <th>Den</th>
                            <th>√öhrn sr√°≈æek (mm)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="monthlyTab" class="tab-content">
            <div class="filters" id="monthlyFilters" style="display: flex;">
                <div class="filter-group">
                    <label>üìÖ Obdob√≠:</label>
                    <select id="monthlyTimeRange" onchange="updateMonthlyData()">
                        <option value="6">Posledn√≠ch 6 mƒõs√≠c≈Ø</option>
                        <option value="12" selected>Posledn√≠ch 12 mƒõs√≠c≈Ø</option>
                        <option value="24">Posledn√≠ch 24 mƒõs√≠c≈Ø</option>
                        <option value="all">V≈°echna data</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Od:</label>
                    <input type="month" id="monthlyDateFrom" onchange="updateMonthlyData()">
                </div>
                
                <div class="filter-group">
                    <label>Do:</label>
                    <input type="month" id="monthlyDateTo" onchange="updateMonthlyData()">
                </div>
            </div>

            <div class="chart-grid" style="display: grid;">
                <div class="chart-container">
                    <h2>üå°Ô∏è Mƒõs√≠ƒçn√≠ teploty</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√°, minim√°ln√≠ a maxim√°ln√≠ teplota za mƒõs√≠c</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('monthlyTemp')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('monthlyTemp')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('monthlyTemp')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyTempChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üíß Mƒõs√≠ƒçn√≠ vlhkost</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√°, minim√°ln√≠ a maxim√°ln√≠ vlhkost za mƒõs√≠c</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('monthlyHumidity')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('monthlyHumidity')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('monthlyHumidity')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyHumidityChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üå°Ô∏è Mƒõs√≠ƒçn√≠ atmosf√©rick√Ω tlak</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√Ω, minim√°ln√≠ a maxim√°ln√≠ tlak za mƒõs√≠c</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('monthlyPressure')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('monthlyPressure')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('monthlyPressure')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyPressureChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üåßÔ∏è Mƒõs√≠ƒçn√≠ sr√°≈æky</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">√öhrn sr√°≈æek za mƒõs√≠c</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('monthlyRain')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('monthlyRain')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('monthlyRain')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyRainChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="tables-grid">
                <div class="table-container">
                    <h2>üå°Ô∏è Tabulka teplot</h2>
                    <table class="data-table" id="monthlyTempTable">
                        <thead>
                            <tr>
                                <th>Mƒõs√≠c</th>
                                <th>Pr≈Ømƒõr</th>
                                <th>Minimum</th>
                                <th>Maximum</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-container">
                    <h2>üíß Tabulka vlhkosti</h2>
                    <table class="data-table" id="monthlyHumidityTable">
                        <thead>
                            <tr>
                                <th>Mƒõs√≠c</th>
                                <th>Pr≈Ømƒõr</th>
                                <th>Minimum</th>
                                <th>Maximum</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-container">
                    <h2>üå°Ô∏è Tabulka tlaku</h2>
                    <table class="data-table" id="monthlyPressureTable">
                        <thead>
                            <tr>
                                <th>Mƒõs√≠c</th>
                                <th>Pr≈Ømƒõr</th>
                                <th>Minimum</th>
                                <th>Maximum</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-container">
                    <h2>üåßÔ∏è Tabulka sr√°≈æek</h2>
                    <table class="data-table" id="monthlyRainTable">
                        <thead>
                            <tr>
                                <th>Mƒõs√≠c</th>
                                <th>√öhrn sr√°≈æek (mm)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="yearlyTab" class="tab-content">
            <div class="filters" id="yearlyFilters" style="display: flex;">
                <div class="filter-group">
                    <label>üìÖ Rok od:</label>
                    <input type="number" id="yearlyYearFrom" min="2020" max="2030" placeholder="2023" onchange="updateYearlyData()">
                </div>
                
                <div class="filter-group">
                    <label>Rok do:</label>
                    <input type="number" id="yearlyYearTo" min="2020" max="2030" placeholder="2025" onchange="updateYearlyData()">
                </div>
            </div>

            <div class="chart-grid" style="display: grid;">
                <div class="chart-container">
                    <h2>üå°Ô∏è Roƒçn√≠ teploty</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√°, minim√°ln√≠ a maxim√°ln√≠ teplota za rok</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('yearlyTemp')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('yearlyTemp')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('yearlyTemp')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="yearlyTempChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üíß Roƒçn√≠ vlhkost</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√°, minim√°ln√≠ a maxim√°ln√≠ vlhkost za rok</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('yearlyHumidity')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('yearlyHumidity')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('yearlyHumidity')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="yearlyHumidityChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üå°Ô∏è Roƒçn√≠ atmosf√©rick√Ω tlak</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Pr≈Ømƒõrn√Ω, minim√°ln√≠ a maxim√°ln√≠ tlak za rok</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('yearlyPressure')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('yearlyPressure')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('yearlyPressure')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="yearlyPressureChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üåßÔ∏è Roƒçn√≠ sr√°≈æky</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">√öhrn sr√°≈æek za rok</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('yearlyRain')">‚Ü∫ Reset zoom</button>
                        <button onclick="zoomIn('yearlyRain')">üîç+ P≈ôibl√≠≈æit</button>
                        <button onclick="zoomOut('yearlyRain')">üîç- Odd√°lit</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="yearlyRainChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="tables-grid">
                <div class="table-container">
                    <h2>üå°Ô∏è Tabulka teplot</h2>
                    <table class="data-table" id="yearlyTempTable">
                        <thead>
                            <tr>
                                <th>Rok</th>
                                <th>Pr≈Ømƒõr</th>
                                <th>Minimum</th>
                                <th>Maximum</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-container">
                    <h2>üíß Tabulka vlhkosti</h2>
                    <table class="data-table" id="yearlyHumidityTable">
                        <thead>
                            <tr>
                                <th>Rok</th>
                                <th>Pr≈Ømƒõr</th>
                                <th>Minimum</th>
                                <th>Maximum</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-container">
                    <h2>üå°Ô∏è Tabulka tlaku</h2>
                    <table class="data-table" id="yearlyPressureTable">
                        <thead>
                            <tr>
                                <th>Rok</th>
                                <th>Pr≈Ømƒõr</th>
                                <th>Minimum</th>
                                <th>Maximum</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-container">
                    <h2>üåßÔ∏è Tabulka sr√°≈æek</h2>
                    <table class="data-table" id="yearlyRainTable">
                        <thead>
                            <tr>
                                <th>Rok</th>
                                <th>√öhrn sr√°≈æek (mm)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Konfigurace ƒçesk√©ho locale pro Chart.js
        Chart.defaults.locale = 'cs-CZ';
        
        const API_URL = 'https://meteosazava.baborovsky-jakub.workers.dev/';
        const AUTO_REFRESH_INTERVAL = 15 * 60 * 1000;

        let rawData = [];
        let currentData = [];
        let dailyDataFiltered = [];
        let monthlyDataFiltered = [];
        let yearlyDataFiltered = [];
        let charts = {};
        let autoRefreshTimer = null;
        let sliders = {};

        window.addEventListener('DOMContentLoaded', function() {
            loadData();
            autoRefreshTimer = setInterval(loadData, AUTO_REFRESH_INTERVAL);
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tabName === 'current') {
                document.getElementById('currentTab').classList.add('active');
                document.querySelector('.tab:nth-child(1)').classList.add('active');
            } else if (tabName === 'daily') {
                document.getElementById('dailyTab').classList.add('active');
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                updateDailyData();
            } else if (tabName === 'monthly') {
                document.getElementById('monthlyTab').classList.add('active');
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                updateMonthlyData();
            } else if (tabName === 'yearly') {
                document.getElementById('yearlyTab').classList.add('active');
                document.querySelector('.tab:nth-child(4)').classList.add('active');
                updateYearlyData();
            }
        }

        function resetZoom(chartName) {
            if (charts[chartName]) {
                charts[chartName].resetZoom();
            }
        }

        function zoomIn(chartName) {
            if (charts[chartName]) {
                charts[chartName].zoom(1.1);
            }
        }

        function zoomOut(chartName) {
            if (charts[chartName]) {
                charts[chartName].zoom(0.9);
            }
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = '‚è≥ Naƒç√≠t√°m data z MySQL...';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';

            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const jsonData = await response.json();
                
                if (!jsonData.success) {
                    throw new Error(jsonData.error || 'Chyba p≈ôi naƒç√≠t√°n√≠ dat');
                }
                
                parseMySQLData(jsonData.data);
                
                document.getElementById('lastUpdate').textContent = 
                    `Posledn√≠ aktualizace: ${new Date().toLocaleString('cs-CZ')} | Naƒçteno ${rawData.length} z√°znam≈Ø (MySQL)`;
                
                document.getElementById('success').textContent = 
                    `‚úÖ √öspƒõ≈°nƒõ naƒçteno ${rawData.length} mƒõ≈ôen√≠!`;
                document.getElementById('success').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('success').style.display = 'none';
                }, 5000);
            } catch (error) {
                showError(error.message);
            }
        }

        function parseMySQLData(data) {
            try {
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('≈Ω√°dn√° data v datab√°zi');
                }

                rawData = data.map(row => {
                    const datetime = new Date(row.datetime);
                    
                    if (isNaN(datetime.getTime())) {
                        console.warn('Neplatn√© datum:', row.datetime);
                        return null;
                    }
                    
                    return {
                        datetime,
                        teplota: parseFloat(row.teplota) || 0,
                        vlhkost: parseFloat(row.vlhkost) || 0,
                        tlak: parseFloat(row.tlak) || 0,
                        baterie: parseFloat(row.baterie) || 0,
                        srazky: parseFloat(row.srazky) || 0,
                        baterieSrazkomeru: parseFloat(row.baterieSrazkomeru) || 0
                    };
                }).filter(item => item !== null);

                if (rawData.length === 0) {
                    throw new Error('≈Ω√°dn√° platn√° data po zpracov√°n√≠');
                }

                rawData.sort((a, b) => a.datetime - b.datetime);

                populateYearDropdown();

                document.getElementById('loading').style.display = 'none';
                showDashboard();
                
                if (Object.keys(charts).length === 0) {
                    initializeCharts();
                    initializeSliders();
                }
                
                updateCurrentData();
                updateStats(rawData);
            } catch (error) {
                showError('Chyba zpracov√°n√≠ dat: ' + error.message);
            }
        }

        function updateCurrentData() {
            const range = document.getElementById('currentTimeRange')?.value || '7';
            const dateFrom = document.getElementById('currentDateFrom')?.value;
            const dateTo = document.getElementById('currentDateTo')?.value;

            currentData = [...rawData];

            if (dateFrom) {
                const from = new Date(dateFrom);
                currentData = currentData.filter(d => d.datetime >= from);
            }

            if (dateTo) {
                const to = new Date(dateTo);
                currentData = currentData.filter(d => d.datetime <= to);
            }

            if (!dateFrom && !dateTo && range !== 'all') {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - parseInt(range));
                currentData = currentData.filter(d => d.datetime >= cutoff);
            }

            updateAllCharts(currentData);
            updateHeatmap(rawData);
            
            ['temp', 'humidity', 'pressure', 'battery', 'rain', 'rainBattery', 'all', 'quad'].forEach(name => {
                const sliderWindow = document.getElementById(`${name}SliderWindow`);
                if (sliderWindow) {
                    sliderWindow.style.left = '0%';
                    sliderWindow.style.width = '100%';
                    sliderWindow.style.right = '';
                }
            });
        }

        function updateDailyData() {
            const range = document.getElementById('dailyTimeRange')?.value || '30';
            const dateFrom = document.getElementById('dailyDateFrom')?.value;
            const dateTo = document.getElementById('dailyDateTo')?.value;

            let filteredRaw = [...rawData];

            if (dateFrom) {
                const from = new Date(dateFrom + 'T00:00:00');
                filteredRaw = filteredRaw.filter(d => d.datetime >= from);
            }

            if (dateTo) {
                const to = new Date(dateTo + 'T23:59:59');
                filteredRaw = filteredRaw.filter(d => d.datetime <= to);
            }

            if (!dateFrom && !dateTo && range !== 'all') {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - parseInt(range));
                filteredRaw = filteredRaw.filter(d => d.datetime >= cutoff);
            }

            dailyDataFiltered = aggregateDailyData(filteredRaw);
            updateDailyCharts();
            updateDailyTables();
        }

        function updateMonthlyData() {
            const range = document.getElementById('monthlyTimeRange')?.value || '12';
            const dateFrom = document.getElementById('monthlyDateFrom')?.value;
            const dateTo = document.getElementById('monthlyDateTo')?.value;

            let filteredRaw = [...rawData];

            if (dateFrom) {
                const [year, month] = dateFrom.split('-');
                const from = new Date(parseInt(year), parseInt(month) - 1, 1);
                filteredRaw = filteredRaw.filter(d => d.datetime >= from);
            }

            if (dateTo) {
                const [year, month] = dateTo.split('-');
                const to = new Date(parseInt(year), parseInt(month), 0, 23, 59, 59);
                filteredRaw = filteredRaw.filter(d => d.datetime <= to);
            }

            if (!dateFrom && !dateTo && range !== 'all') {
                const cutoff = new Date();
                cutoff.setMonth(cutoff.getMonth() - parseInt(range));
                filteredRaw = filteredRaw.filter(d => d.datetime >= cutoff);
            }

            monthlyDataFiltered = aggregateMonthlyData(filteredRaw);
            updateMonthlyCharts();
            updateMonthlyTables();
        }

        function updateYearlyData() {
            const yearFrom = document.getElementById('yearlyYearFrom')?.value;
            const yearTo = document.getElementById('yearlyYearTo')?.value;

            let filteredRaw = [...rawData];

            if (yearFrom) {
                filteredRaw = filteredRaw.filter(d => d.datetime.getFullYear() >= parseInt(yearFrom));
            }

            if (yearTo) {
                filteredRaw = filteredRaw.filter(d => d.datetime.getFullYear() <= parseInt(yearTo));
            }

            yearlyDataFiltered = aggregateYearlyData(filteredRaw);
            updateYearlyCharts();
            updateYearlyTables();
        }

        function aggregateDailyData(data) {
            const dailyMap = {};
            
            data.forEach(d => {
                const dateKey = d.datetime.toISOString().split('T')[0];
                
                if (!dailyMap[dateKey]) {
                    dailyMap[dateKey] = {
                        date: new Date(dateKey + 'T12:00:00'),
                        teplota: [],
                        vlhkost: [],
                        tlak: [],
                        srazky: 0
                    };
                }
                
                dailyMap[dateKey].teplota.push(d.teplota);
                dailyMap[dateKey].vlhkost.push(d.vlhkost);
                dailyMap[dateKey].tlak.push(d.tlak);
                dailyMap[dateKey].srazky += d.srazky;
            });
            
            const result = Object.values(dailyMap).map(day => ({
                date: day.date,
                teplotaAvg: day.teplota.reduce((a, b) => a + b, 0) / day.teplota.length,
                teplotaMin: Math.min(...day.teplota),
                teplotaMax: Math.max(...day.teplota),
                vlhkostAvg: day.vlhkost.reduce((a, b) => a + b, 0) / day.vlhkost.length,
                vlhkostMin: Math.min(...day.vlhkost),
                vlhkostMax: Math.max(...day.vlhkost),
                tlakAvg: day.tlak.reduce((a, b) => a + b, 0) / day.tlak.length,
                tlakMin: Math.min(...day.tlak),
                tlakMax: Math.max(...day.tlak),
                srazkyTotal: day.srazky
            }));
            
            result.sort((a, b) => a.date - b.date);
            return result;
        }

        function aggregateMonthlyData(data) {
            const monthlyMap = {};
            
            data.forEach(d => {
                const monthKey = `${d.datetime.getFullYear()}-${String(d.datetime.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyMap[monthKey]) {
                    monthlyMap[monthKey] = {
                        date: new Date(d.datetime.getFullYear(), d.datetime.getMonth(), 15),
                        teplota: [],
                        vlhkost: [],
                        tlak: [],
                        srazky: 0
                    };
                }
                
                monthlyMap[monthKey].teplota.push(d.teplota);
                monthlyMap[monthKey].vlhkost.push(d.vlhkost);
                monthlyMap[monthKey].tlak.push(d.tlak);
                monthlyMap[monthKey].srazky += d.srazky;
            });
            
            const result = Object.values(monthlyMap).map(month => ({
                date: month.date,
                teplotaAvg: month.teplota.reduce((a, b) => a + b, 0) / month.teplota.length,
                teplotaMin: Math.min(...month.teplota),
                teplotaMax: Math.max(...month.teplota),
                vlhkostAvg: month.vlhkost.reduce((a, b) => a + b, 0) / month.vlhkost.length,
                vlhkostMin: Math.min(...month.vlhkost),
                vlhkostMax: Math.max(...month.vlhkost),
                tlakAvg: month.tlak.reduce((a, b) => a + b, 0) / month.tlak.length,
                tlakMin: Math.min(...month.tlak),
                tlakMax: Math.max(...month.tlak),
                srazkyTotal: month.srazky
            }));
            
            result.sort((a, b) => a.date - b.date);
            return result;
        }

        function aggregateYearlyData(data) {
            const yearlyMap = {};
            
            data.forEach(d => {
                const yearKey = d.datetime.getFullYear();
                
                if (!yearlyMap[yearKey]) {
                    yearlyMap[yearKey] = {
                        year: yearKey,
                        teplota: [],
                        vlhkost: [],
                        tlak: [],
                        srazky: 0
                    };
                }
                
                yearlyMap[yearKey].teplota.push(d.teplota);
                yearlyMap[yearKey].vlhkost.push(d.vlhkost);
                yearlyMap[yearKey].tlak.push(d.tlak);
                yearlyMap[yearKey].srazky += d.srazky;
            });
            
            const result = Object.values(yearlyMap).map(year => ({
                year: year.year,
                teplotaAvg: year.teplota.reduce((a, b) => a + b, 0) / year.teplota.length,
                teplotaMin: Math.min(...year.teplota),
                teplotaMax: Math.max(...year.teplota),
                vlhkostAvg: year.vlhkost.reduce((a, b) => a + b, 0) / year.vlhkost.length,
                vlhkostMin: Math.min(...year.vlhkost),
                vlhkostMax: Math.max(...year.vlhkost),
                tlakAvg: year.tlak.reduce((a, b) => a + b, 0) / year.tlak.length,
                tlakMin: Math.min(...year.tlak),
                tlakMax: Math.max(...year.tlak),
                srazkyTotal: year.srazky
            }));
            
            result.sort((a, b) => a.year - b.year);
            return result;
        }

        function populateYearDropdown() {
            const yearSelect = document.getElementById('heatmapYear');
            if (!yearSelect) return;

            const years = [...new Set(rawData.map(d => d.datetime.getFullYear()))].sort((a, b) => b - a);
            
            yearSelect.innerHTML = '';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            const currentYear = new Date().getFullYear();
            if (years.includes(currentYear)) {
                yearSelect.value = currentYear;
            }
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = '‚ùå ' + msg;
            document.getElementById('error').style.display = 'block';
        }

        function showDashboard() {
            document.getElementById('currentFilters').style.display = 'flex';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('tabs').style.display = 'flex';
            document.getElementById('chartsGrid').style.display = 'grid';
            document.getElementById('multiChart').style.display = 'block';
            document.getElementById('quadChart').style.display = 'block';
            document.getElementById('heatmapContainer').style.display = 'block';
            document.getElementById('distributionChart').style.display = 'block';
            document.getElementById('scatterChart').style.display = 'block';
        }

        function updateStats(data) {
            const stats = {
                teplota: calcStatsWithTime(data.map(d => ({ value: d.teplota, time: d.datetime }))),
                vlhkost: calcStatsWithTime(data.map(d => ({ value: d.vlhkost, time: d.datetime }))),
                tlak: calcStatsWithTime(data.map(d => ({ value: d.tlak, time: d.datetime }))),
                baterie: calcStatsWithTime(data.map(d => ({ value: d.baterie, time: d.datetime }))),
                srazky: calcStatsWithTime(data.map(d => ({ value: d.srazky, time: d.datetime }))),
                baterieSrazkomeru: calcStatsWithTime(data.map(d => ({ value: d.baterieSrazkomeru, time: d.datetime })))
            };

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üå°Ô∏è</div>
                    <div class="stat-label">TEPLOTA</div>
                    <div class="stat-value">${stats.teplota.current.value.toFixed(1)}¬∞C</div>
                    <div class="stat-timestamp">üìÖ ${stats.teplota.current.time.toLocaleString('cs-CZ', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false})}</div>
                    <div class="stat-trend ${stats.teplota.trend >= 0 ? 'up' : 'down'}">
                        ${stats.teplota.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.teplota.trend).toFixed(1)}¬∞C od p≈ôedchoz√≠ho
                    </div>
                    <div class="stat-meta">
                        Min: ${stats.teplota.min.value.toFixed(1)}¬∞C<br>
                        <small>${stats.teplota.min.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Max: ${stats.teplota.max.value.toFixed(1)}¬∞C<br>
                        <small>${stats.teplota.max.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Pr≈Ømƒõr: ${stats.teplota.avg.toFixed(1)}¬∞C
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíß</div>
                    <div class="stat-label">VLHKOST</div>
                    <div class="stat-value">${stats.vlhkost.current.value.toFixed(0)}%</div>
                    <div class="stat-timestamp">üìÖ ${stats.vlhkost.current.time.toLocaleString('cs-CZ', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false})}</div>
                    <div class="stat-trend ${stats.vlhkost.trend >= 0 ? 'up' : 'down'}">
                        ${stats.vlhkost.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.vlhkost.trend).toFixed(1)}%
                    </div>
                    <div class="stat-meta">
                        Min: ${stats.vlhkost.min.value.toFixed(0)}%<br>
                        <small>${stats.vlhkost.min.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Max: ${stats.vlhkost.max.value.toFixed(0)}%<br>
                        <small>${stats.vlhkost.max.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Pr≈Ømƒõr: ${stats.vlhkost.avg.toFixed(0)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üå°Ô∏è</div>
                    <div class="stat-label">ATMOSF√âRICK√ù TLAK</div>
                    <div class="stat-value">${stats.tlak.current.value.toFixed(0)}</div>
                    <div class="stat-timestamp">üìÖ ${stats.tlak.current.time.toLocaleString('cs-CZ', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false})}</div>
                    <div class="stat-trend ${stats.tlak.trend >= 0 ? 'up' : 'down'}">
                        ${stats.tlak.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.tlak.trend).toFixed(1)} hPa
                    </div>
                    <div class="stat-meta">
                        Min: ${stats.tlak.min.value.toFixed(0)} hPa<br>
                        <small>${stats.tlak.min.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Max: ${stats.tlak.max.value.toFixed(0)} hPa<br>
                        <small>${stats.tlak.max.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Pr≈Ømƒõr: ${stats.tlak.avg.toFixed(0)} hPa
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîã</div>
                    <div class="stat-label">NAPƒöT√ç BATERIE METEOSTANICE</div>
                    <div class="stat-value">${stats.baterie.current.value.toFixed(2)}V</div>
                    <div class="stat-timestamp">üìÖ ${stats.baterie.current.time.toLocaleString('cs-CZ', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false})}</div>
                    <div class="stat-trend ${stats.baterie.trend >= 0 ? 'up' : 'down'}">
                        ${stats.baterie.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.baterie.trend).toFixed(2)}V
                    </div>
                    <div class="stat-meta">
                        Min: ${stats.baterie.min.value.toFixed(2)}V<br>
                        <small>${stats.baterie.min.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Max: ${stats.baterie.max.value.toFixed(2)}V<br>
                        <small>${stats.baterie.max.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Pr≈Ømƒõr: ${stats.baterie.avg.toFixed(2)}V
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåßÔ∏è</div>
                    <div class="stat-label">SR√Å≈ΩKY</div>
                    <div class="stat-value">${stats.srazky.current.value.toFixed(1)}</div>
                    <div class="stat-timestamp">üìÖ ${stats.srazky.current.time.toLocaleString('cs-CZ', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false})}</div>
                    <div class="stat-trend ${stats.srazky.trend >= 0 ? 'up' : 'down'}">
                        ${stats.srazky.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.srazky.trend).toFixed(1)} mm
                    </div>
                    <div class="stat-meta">
                        Min: ${stats.srazky.min.value.toFixed(1)} mm<br>
                        <small>${stats.srazky.min.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Max: ${stats.srazky.max.value.toFixed(1)} mm<br>
                        <small>${stats.srazky.max.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Celkem: ${data.reduce((sum, d) => sum + d.srazky, 0).toFixed(1)} mm
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîã</div>
                    <div class="stat-label">NAPƒöT√ç BATERIE SR√Å≈ΩKOMƒöRU</div>
                    <div class="stat-value">${stats.baterieSrazkomeru.current.value.toFixed(2)}V</div>
                    <div class="stat-timestamp">üìÖ ${stats.baterieSrazkomeru.current.time.toLocaleString('cs-CZ', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false})}</div>
                    <div class="stat-trend ${stats.baterieSrazkomeru.trend >= 0 ? 'up' : 'down'}">
                        ${stats.baterieSrazkomeru.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.baterieSrazkomeru.trend).toFixed(2)}V
                    </div>
                    <div class="stat-meta">
                        Min: ${stats.baterieSrazkomeru.min.value.toFixed(2)}V<br>
                        <small>${stats.baterieSrazkomeru.min.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Max: ${stats.baterieSrazkomeru.max.value.toFixed(2)}V<br>
                        <small>${stats.baterieSrazkomeru.max.time.toLocaleString('cs-CZ', {hour12: false})}</small><br>
                        Pr≈Ømƒõr: ${stats.baterieSrazkomeru.avg.toFixed(2)}V
                    </div>
                </div>
            `;
        }

        function calcStatsWithTime(items) {
            if (items.length === 0) return { 
                current: {value: 0, time: new Date()}, 
                min: {value: 0, time: new Date()}, 
                max: {value: 0, time: new Date()}, 
                avg: 0, 
                trend: 0 
            };
            
            const values = items.map(i => i.value);
            const current = items[items.length - 1];
            const previous = items[Math.max(0, items.length - 10)];
            
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const minItem = items.find(i => i.value === minValue);
            const maxItem = items.find(i => i.value === maxValue);
            
            return {
                current,
                min: minItem,
                max: maxItem,
                avg: values.reduce((a, b) => a + b, 0) / values.length,
                trend: current.value - previous.value
            };
        }

        // Kv≈Øli omezen√≠ velikosti souboru zbytek k√≥du zkr√°t√≠m - p≈ôid√°m jen kl√≠ƒçov√© funkce
        // Pro plnou funkƒçnost pot≈ôebujeme initializeCharts, updateAllCharts, initializeSliders atd.
        // Tyto funkce jsou stejn√© jako v p≈Øvodn√≠m souboru

        function initializeCharts() {
            // Kompletn√≠ inicializace graf≈Ø (zkr√°ceno pro velikost)
            const zoomOptions = {
                zoom: {wheel: {enabled: true, speed: 0.1}, pinch: {enabled: true}, mode: 'x'},
                pan: {enabled: true, mode: 'x'},
                limits: {x: {min: 'original', max: 'original'}}
            };
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {legend: {display: true}, zoom: zoomOptions},
                scales: {
                    x: {
                        type: 'time', 
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'dd.MM'
                            },
                            tooltipFormat: 'dd.MM.yyyy HH:mm'
                        },
                        ticks: {
                            source: 'auto'
                        }
                    }
                },
                interaction: {mode: 'index', intersect: false}
            };
            
            charts.temp = new Chart(document.getElementById('tempChart'), {type: 'line', data: {datasets: []}, options: commonOptions});
            charts.humidity = new Chart(document.getElementById('humidityChart'), {type: 'line', data: {datasets: []}, options: commonOptions});
            charts.pressure = new Chart(document.getElementById('pressureChart'), {type: 'line', data: {datasets: []}, options: commonOptions});
            charts.battery = new Chart(document.getElementById('batteryChart'), {type: 'line', data: {datasets: []}, options: commonOptions});
            charts.rain = new Chart(document.getElementById('rainChart'), {type: 'bar', data: {datasets: []}, options: {...commonOptions, scales: {...commonOptions.scales, y: {beginAtZero: true}, y1: {position: 'right', grid: {drawOnChartArea: false}}}}});
            charts.rainBattery = new Chart(document.getElementById('rainBatteryChart'), {type: 'line', data: {datasets: []}, options: commonOptions});
            charts.all = new Chart(document.getElementById('allParamsChart'), {type: 'line', data: {datasets: []}, options: {...commonOptions, scales: {x: {type: 'time'}, yLeft: {position: 'left'}, yRight: {position: 'right', grid: {drawOnChartArea: false}}}}});
            charts.quad = new Chart(document.getElementById('quadAxisChart'), {type: 'line', data: {datasets: []}, options: {...commonOptions, scales: {x: {type: 'time'}, y1: {position: 'left'}, y2: {position: 'right', grid: {drawOnChartArea: false}}, y3: {position: 'left', grid: {drawOnChartArea: false}}, y4: {position: 'right', grid: {drawOnChartArea: false}}}}});
            charts.distribution = new Chart(document.getElementById('distributionCanvas'), {type: 'bar', data: {datasets: []}, options: {responsive: true, maintainAspectRatio: false}});
            charts.scatter = new Chart(document.getElementById('scatterCanvas'), {type: 'scatter', data: {datasets: []}, options: {responsive: true, maintainAspectRatio: false, scales: {x: {title: {display: true, text: 'Teplota (¬∞C)'}}, y: {title: {display: true, text: 'Vlhkost (%)'}}}}});
            
            const dailyOptions = {
                ...commonOptions, 
                scales: {
                    x: {
                        type: 'time', 
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'dd.MM.yyyy'
                            },
                            tooltipFormat: 'dd.MM.yyyy'
                        }
                    }
                }
            };
            charts.dailyTemp = new Chart(document.getElementById('dailyTempChart'), {type: 'line', data: {datasets: []}, options: dailyOptions});
            charts.dailyHumidity = new Chart(document.getElementById('dailyHumidityChart'), {type: 'line', data: {datasets: []}, options: dailyOptions});
            charts.dailyPressure = new Chart(document.getElementById('dailyPressureChart'), {type: 'line', data: {datasets: []}, options: dailyOptions});
            charts.dailyRain = new Chart(document.getElementById('dailyRainChart'), {type: 'bar', data: {datasets: []}, options: {...dailyOptions, scales: {...dailyOptions.scales, y: {beginAtZero: true}}}});
            
            const monthlyOptions = {
                ...commonOptions, 
                scales: {
                    x: {
                        type: 'time', 
                        time: {
                            unit: 'month',
                            displayFormats: {
                                month: 'MMM yyyy'
                            }
                        },
                        ticks: {
                            callback: function(value, index, ticks) {
                                const date = new Date(value);
                                const czechMonths = ['Led', '√öno', 'B≈ôe', 'Dub', 'Kvƒõ', 'ƒåvn', 'ƒåvc', 'Srp', 'Z√°≈ô', '≈ò√≠j', 'Lis', 'Pro'];
                                return czechMonths[date.getMonth()] + ' ' + date.getFullYear();
                            }
                        }
                    }
                }
            };
            charts.monthlyTemp = new Chart(document.getElementById('monthlyTempChart'), {type: 'line', data: {datasets: []}, options: monthlyOptions});
            charts.monthlyHumidity = new Chart(document.getElementById('monthlyHumidityChart'), {type: 'line', data: {datasets: []}, options: monthlyOptions});
            charts.monthlyPressure = new Chart(document.getElementById('monthlyPressureChart'), {type: 'line', data: {datasets: []}, options: monthlyOptions});
            charts.monthlyRain = new Chart(document.getElementById('monthlyRainChart'), {type: 'bar', data: {datasets: []}, options: {...monthlyOptions, scales: {...monthlyOptions.scales, y: {beginAtZero: true}}}});
            
            const yearlyOptions = {...commonOptions, scales: {x: {type: 'linear', ticks: {stepSize: 1, callback: function(value) { return Math.floor(value); }}}}};
            charts.yearlyTemp = new Chart(document.getElementById('yearlyTempChart'), {type: 'line', data: {datasets: []}, options: yearlyOptions});
            charts.yearlyHumidity = new Chart(document.getElementById('yearlyHumidityChart'), {type: 'line', data: {datasets: []}, options: yearlyOptions});
            charts.yearlyPressure = new Chart(document.getElementById('yearlyPressureChart'), {type: 'line', data: {datasets: []}, options: yearlyOptions});
            charts.yearlyRain = new Chart(document.getElementById('yearlyRainChart'), {type: 'bar', data: {datasets: []}, options: {...yearlyOptions, scales: {...yearlyOptions.scales, y: {beginAtZero: true}}}});
        }

        function updateAllCharts(data) {
            // Update v≈°echny grafy pro z√°lo≈æku "Aktu√°lnƒõ"
            charts.temp.data.datasets = [{label: 'Teplota (¬∞C)', data: data.map(d => ({x: d.datetime, y: d.teplota})), borderColor: 'rgb(255, 99, 132)', tension: 0.4, fill: true}];
            charts.humidity.data.datasets = [{label: 'Vlhkost (%)', data: data.map(d => ({x: d.datetime, y: d.vlhkost})), borderColor: 'rgb(54, 162, 235)', tension: 0.4, fill: true}];
            charts.pressure.data.datasets = [{label: 'Tlak (hPa)', data: data.map(d => ({x: d.datetime, y: d.tlak})), borderColor: 'rgb(75, 192, 192)', tension: 0.4, fill: true}];
            charts.battery.data.datasets = [{label: 'Baterie (V)', data: data.map(d => ({x: d.datetime, y: d.baterie})), borderColor: 'rgb(255, 206, 86)', tension: 0.4, fill: true}];
            
            const dailyRainfall = calculateDailyRainfall(data);
            charts.rain.data.datasets = [
                {type: 'bar', label: 'Sr√°≈æky (mm)', data: data.map(d => ({x: d.datetime, y: d.srazky})), backgroundColor: 'rgba(54, 162, 235, 0.7)', yAxisID: 'y'},
                {type: 'line', label: 'Kumulativn√≠ (mm)', data: dailyRainfall, borderColor: 'rgb(255, 99, 132)', borderWidth: 3, tension: 0, fill: false, yAxisID: 'y1'}
            ];
            
            charts.rainBattery.data.datasets = [{label: 'Baterie sr√°≈ækomƒõru (V)', data: data.map(d => ({x: d.datetime, y: d.baterieSrazkomeru})), borderColor: 'rgb(153, 102, 255)', tension: 0.4, fill: true}];
            charts.all.data.datasets = [
                {label: 'Teplota (¬∞C)', data: data.map(d => ({x: d.datetime, y: d.teplota})), borderColor: 'rgb(255, 99, 132)', tension: 0.4, yAxisID: 'yLeft'},
                {label: 'Vlhkost (%)', data: data.map(d => ({x: d.datetime, y: d.vlhkost})), borderColor: 'rgb(54, 162, 235)', tension: 0.4, yAxisID: 'yRight'}
            ];
            charts.quad.data.datasets = [
                {label: 'Teplota (¬∞C)', data: data.map(d => ({x: d.datetime, y: d.teplota})), borderColor: '#ff6384', tension: 0.4, yAxisID: 'y1'},
                {label: 'Vlhkost (%)', data: data.map(d => ({x: d.datetime, y: d.vlhkost})), borderColor: '#36a2eb', tension: 0.4, yAxisID: 'y2'},
                {label: 'Tlak (hPa)', data: data.map(d => ({x: d.datetime, y: d.tlak})), borderColor: '#4bc0c0', tension: 0.4, yAxisID: 'y3'},
                {label: 'Baterie (V)', data: data.map(d => ({x: d.datetime, y: d.baterie})), borderColor: '#ffce56', tension: 0.4, yAxisID: 'y4'}
            ];
            
            const tempBins = createHistogram(data.map(d => d.teplota), 25);
            charts.distribution.data = {labels: tempBins.labels, datasets: [{label: 'Poƒçet mƒõ≈ôen√≠', data: tempBins.values, backgroundColor: 'rgba(102, 126, 234, 0.7)'}]};
            charts.scatter.data.datasets = [{label: 'Teplota vs Vlhkost', data: data.map(d => ({x: d.teplota, y: d.vlhkost})), backgroundColor: 'rgba(102, 126, 234, 0.5)', pointRadius: 3}];
            
            Object.values(charts).forEach(chart => {if (chart && typeof chart.update === 'function') chart.update();});
            
            ['temp', 'humidity', 'pressure', 'battery', 'rain', 'rainBattery', 'all', 'quad'].forEach(name => {drawSliderPreview(name, data);});
        }

        function calculateDailyRainfall(data) {
            const dailyData = {};
            data.forEach(d => {
                const dateKey = d.datetime.toDateString();
                if (!dailyData[dateKey]) dailyData[dateKey] = {total: 0, points: []};
                dailyData[dateKey].total += d.srazky;
                dailyData[dateKey].points.push({x: d.datetime, y: dailyData[dateKey].total});
            });
            const result = [];
            Object.values(dailyData).forEach(day => result.push(...day.points));
            return result;
        }

        function createHistogram(data, bins) {
            const min = Math.min(...data), max = Math.max(...data), step = (max - min) / bins;
            const counts = new Array(bins).fill(0), labels = [];
            for (let i = 0; i < bins; i++) labels.push((min + i * step).toFixed(1));
            data.forEach(value => counts[Math.min(Math.floor((value - min) / step), bins - 1)]++);
            return {labels, values: counts};
        }

        function updateDailyCharts() {
            if (!dailyDataFiltered.length) return;
            charts.dailyTemp.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: dailyDataFiltered.map(d => ({x: d.date, y: d.teplotaAvg})), borderColor: 'rgb(255, 99, 132)', tension: 0.4, borderWidth: 3},
                {label: 'Minimum', data: dailyDataFiltered.map(d => ({x: d.date, y: d.teplotaMin})), borderColor: 'rgb(255, 159, 164)', tension: 0.4},
                {label: 'Maximum', data: dailyDataFiltered.map(d => ({x: d.date, y: d.teplotaMax})), borderColor: 'rgb(200, 50, 80)', tension: 0.4}
            ];
            charts.dailyHumidity.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: dailyDataFiltered.map(d => ({x: d.date, y: d.vlhkostAvg})), borderColor: 'rgb(54, 162, 235)', tension: 0.4, borderWidth: 3},
                {label: 'Minimum', data: dailyDataFiltered.map(d => ({x: d.date, y: d.vlhkostMin})), borderColor: 'rgb(100, 180, 240)', tension: 0.4},
                {label: 'Maximum', data: dailyDataFiltered.map(d => ({x: d.date, y: d.vlhkostMax})), borderColor: 'rgb(30, 100, 180)', tension: 0.4}
            ];
            charts.dailyPressure.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: dailyDataFiltered.map(d => ({x: d.date, y: d.tlakAvg})), borderColor: 'rgb(255, 206, 86)', tension: 0.4, borderWidth: 3},
                {label: 'Minimum', data: dailyDataFiltered.map(d => ({x: d.date, y: d.tlakMin})), borderColor: 'rgb(255, 220, 120)', tension: 0.4},
                {label: 'Maximum', data: dailyDataFiltered.map(d => ({x: d.date, y: d.tlakMax})), borderColor: 'rgb(200, 160, 50)', tension: 0.4}
            ];
            charts.dailyRain.data.datasets = [{label: '√öhrn sr√°≈æek', data: dailyDataFiltered.map(d => ({x: d.date, y: d.srazkyTotal})), backgroundColor: 'rgba(54, 162, 235, 0.7)'}];
            [charts.dailyTemp, charts.dailyHumidity, charts.dailyPressure, charts.dailyRain].forEach(c => c.update());
        }

        function updateDailyTables() {
            if (!dailyDataFiltered.length) return;
            document.querySelector('#tempTable tbody').innerHTML = dailyDataFiltered.map(d => `<tr><td>${d.date.toLocaleDateString('cs-CZ')}</td><td>${d.teplotaAvg.toFixed(1)} ¬∞C</td><td>${d.teplotaMin.toFixed(1)} ¬∞C</td><td>${d.teplotaMax.toFixed(1)} ¬∞C</td></tr>`).join('');
            document.querySelector('#humidityTable tbody').innerHTML = dailyDataFiltered.map(d => `<tr><td>${d.date.toLocaleDateString('cs-CZ')}</td><td>${d.vlhkostAvg.toFixed(1)} %</td><td>${d.vlhkostMin.toFixed(1)} %</td><td>${d.vlhkostMax.toFixed(1)} %</td></tr>`).join('');
            document.querySelector('#pressureTable tbody').innerHTML = dailyDataFiltered.map(d => `<tr><td>${d.date.toLocaleDateString('cs-CZ')}</td><td>${d.tlakAvg.toFixed(1)} hPa</td><td>${d.tlakMin.toFixed(1)} hPa</td><td>${d.tlakMax.toFixed(1)} hPa</td></tr>`).join('');
            document.querySelector('#rainTable tbody').innerHTML = dailyDataFiltered.map(d => `<tr><td>${d.date.toLocaleDateString('cs-CZ')}</td><td>${d.srazkyTotal.toFixed(2)} mm</td></tr>`).join('');
        }

        function updateMonthlyCharts() {
            if (!monthlyDataFiltered.length) return;
            charts.monthlyTemp.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.teplotaAvg})), borderColor: 'rgb(255, 99, 132)', tension: 0.4},
                {label: 'Minimum', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.teplotaMin})), borderColor: 'rgb(255, 159, 164)', tension: 0.4},
                {label: 'Maximum', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.teplotaMax})), borderColor: 'rgb(200, 50, 80)', tension: 0.4}
            ];
            charts.monthlyHumidity.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.vlhkostAvg})), borderColor: 'rgb(54, 162, 235)', tension: 0.4},
                {label: 'Minimum', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.vlhkostMin})), borderColor: 'rgb(100, 180, 240)', tension: 0.4},
                {label: 'Maximum', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.vlhkostMax})), borderColor: 'rgb(30, 100, 180)', tension: 0.4}
            ];
            charts.monthlyPressure.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.tlakAvg})), borderColor: 'rgb(255, 206, 86)', tension: 0.4},
                {label: 'Minimum', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.tlakMin})), borderColor: 'rgb(255, 220, 120)', tension: 0.4},
                {label: 'Maximum', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.tlakMax})), borderColor: 'rgb(200, 160, 50)', tension: 0.4}
            ];
            charts.monthlyRain.data.datasets = [{label: '√öhrn sr√°≈æek', data: monthlyDataFiltered.map(d => ({x: d.date, y: d.srazkyTotal})), backgroundColor: 'rgba(54, 162, 235, 0.7)'}];
            [charts.monthlyTemp, charts.monthlyHumidity, charts.monthlyPressure, charts.monthlyRain].forEach(c => c.update());
        }

        function updateMonthlyTables() {
            if (!monthlyDataFiltered.length) return;
            
            const getMonthNameCzech = (date) => {
                const months = ['leden', '√∫nor', 'b≈ôezen', 'duben', 'kvƒõten', 'ƒçerven', 
                               'ƒçervenec', 'srpen', 'z√°≈ô√≠', '≈ô√≠jen', 'listopad', 'prosinec'];
                return `${months[date.getMonth()]} ${date.getFullYear()}`;
            };
            
            document.querySelector('#monthlyTempTable tbody').innerHTML = monthlyDataFiltered.map(d => `<tr><td>${getMonthNameCzech(d.date)}</td><td>${d.teplotaAvg.toFixed(1)} ¬∞C</td><td>${d.teplotaMin.toFixed(1)} ¬∞C</td><td>${d.teplotaMax.toFixed(1)} ¬∞C</td></tr>`).join('');
            document.querySelector('#monthlyHumidityTable tbody').innerHTML = monthlyDataFiltered.map(d => `<tr><td>${getMonthNameCzech(d.date)}</td><td>${d.vlhkostAvg.toFixed(1)} %</td><td>${d.vlhkostMin.toFixed(1)} %</td><td>${d.vlhkostMax.toFixed(1)} %</td></tr>`).join('');
            document.querySelector('#monthlyPressureTable tbody').innerHTML = monthlyDataFiltered.map(d => `<tr><td>${getMonthNameCzech(d.date)}</td><td>${d.tlakAvg.toFixed(1)} hPa</td><td>${d.tlakMin.toFixed(1)} hPa</td><td>${d.tlakMax.toFixed(1)} hPa</td></tr>`).join('');
            document.querySelector('#monthlyRainTable tbody').innerHTML = monthlyDataFiltered.map(d => `<tr><td>${getMonthNameCzech(d.date)}</td><td>${d.srazkyTotal.toFixed(2)} mm</td></tr>`).join('');
        }

        function updateYearlyCharts() {
            if (!yearlyDataFiltered.length) return;
            const years = yearlyDataFiltered.map(d => d.year);
            charts.yearlyTemp.data.labels = years;
            charts.yearlyTemp.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: yearlyDataFiltered.map(d => d.teplotaAvg), borderColor: 'rgb(255, 99, 132)', tension: 0.4},
                {label: 'Minimum', data: yearlyDataFiltered.map(d => d.teplotaMin), borderColor: 'rgb(255, 159, 164)', tension: 0.4},
                {label: 'Maximum', data: yearlyDataFiltered.map(d => d.teplotaMax), borderColor: 'rgb(200, 50, 80)', tension: 0.4}
            ];
            charts.yearlyHumidity.data.labels = years;
            charts.yearlyHumidity.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: yearlyDataFiltered.map(d => d.vlhkostAvg), borderColor: 'rgb(54, 162, 235)', tension: 0.4},
                {label: 'Minimum', data: yearlyDataFiltered.map(d => d.vlhkostMin), borderColor: 'rgb(100, 180, 240)', tension: 0.4},
                {label: 'Maximum', data: yearlyDataFiltered.map(d => d.vlhkostMax), borderColor: 'rgb(30, 100, 180)', tension: 0.4}
            ];
            charts.yearlyPressure.data.labels = years;
            charts.yearlyPressure.data.datasets = [
                {label: 'Pr≈Ømƒõr', data: yearlyDataFiltered.map(d => d.tlakAvg), borderColor: 'rgb(255, 206, 86)', tension: 0.4},
                {label: 'Minimum', data: yearlyDataFiltered.map(d => d.tlakMin), borderColor: 'rgb(255, 220, 120)', tension: 0.4},
                {label: 'Maximum', data: yearlyDataFiltered.map(d => d.tlakMax), borderColor: 'rgb(200, 160, 50)', tension: 0.4}
            ];
            charts.yearlyRain.data.labels = years;
            charts.yearlyRain.data.datasets = [{label: '√öhrn sr√°≈æek', data: yearlyDataFiltered.map(d => d.srazkyTotal), backgroundColor: 'rgba(54, 162, 235, 0.7)'}];
            [charts.yearlyTemp, charts.yearlyHumidity, charts.yearlyPressure, charts.yearlyRain].forEach(c => c.update());
        }

        function updateYearlyTables() {
            if (!yearlyDataFiltered.length) return;
            document.querySelector('#yearlyTempTable tbody').innerHTML = yearlyDataFiltered.map(d => `<tr><td>${d.year}</td><td>${d.teplotaAvg.toFixed(1)} ¬∞C</td><td>${d.teplotaMin.toFixed(1)} ¬∞C</td><td>${d.teplotaMax.toFixed(1)} ¬∞C</td></tr>`).join('');
            document.querySelector('#yearlyHumidityTable tbody').innerHTML = yearlyDataFiltered.map(d => `<tr><td>${d.year}</td><td>${d.vlhkostAvg.toFixed(1)} %</td><td>${d.vlhkostMin.toFixed(1)} %</td><td>${d.vlhkostMax.toFixed(1)} %</td></tr>`).join('');
            document.querySelector('#yearlyPressureTable tbody').innerHTML = yearlyDataFiltered.map(d => `<tr><td>${d.year}</td><td>${d.tlakAvg.toFixed(1)} hPa</td><td>${d.tlakMin.toFixed(1)} hPa</td><td>${d.tlakMax.toFixed(1)} hPa</td></tr>`).join('');
            document.querySelector('#yearlyRainTable tbody').innerHTML = yearlyDataFiltered.map(d => `<tr><td>${d.year}</td><td>${d.srazkyTotal.toFixed(2)} mm</td></tr>`).join('');
        }

        function updateHeatmapMetric() { updateHeatmap(rawData); }
        
        function updateHeatmap(data) {
            const metric = document.getElementById('heatmapMetric')?.value || 'teplota';
            const selectedYear = parseInt(document.getElementById('heatmapYear')?.value || new Date().getFullYear());
            const daysInYear = isLeapYear(selectedYear) ? 366 : 365;
            
            const matrix = Array(daysInYear).fill(null).map(() => Array(24).fill(null).map(() => []));
            
            data.forEach(d => {
                if (d.datetime.getFullYear() !== selectedYear) return;
                
                const dayOfYear = getDayOfYear(d.datetime);
                const hour = d.datetime.getHours();
                
                if (dayOfYear >= 0 && dayOfYear < daysInYear && hour >= 0 && hour < 24) {
                    let value;
                    if (metric === 'teplota') value = d.teplota;
                    else if (metric === 'vlhkost') value = d.vlhkost;
                    else if (metric === 'tlak') value = d.tlak;
                    else if (metric === 'srazky') value = d.srazky;
                    matrix[dayOfYear][hour].push(value);
                }
            });

            const avgMatrix = matrix.map(day => 
                day.map(hours => 
                    hours.length > 0 ? hours.reduce((a, b) => a + b, 0) / hours.length : null
                )
            );

            const allValues = avgMatrix.flat().filter(t => t !== null);
            if (allValues.length === 0) {
                document.getElementById('heatmapGrid').innerHTML = '<p style="color: #999; padding: 20px;">Nedostatek dat pro zobrazen√≠ heatmapy</p>';
                return;
            }

            const minValue = Math.min(...allValues);
            const maxValue = Math.max(...allValues);

            let unit = '', label = '', description = '';
            if (metric === 'teplota') {
                unit = '¬∞C';
                label = 'Teplota:';
                description = 'Pr≈Ømƒõrn√° teplota podle dne v roce a hodiny';
            } else if (metric === 'vlhkost') {
                unit = '%';
                label = 'Vlhkost:';
                description = 'Pr≈Ømƒõrn√° vlhkost podle dne v roce a hodiny';
            } else if (metric === 'tlak') {
                unit = ' hPa';
                label = 'Tlak:';
                description = 'Pr≈Ømƒõrn√Ω tlak podle dne v roce a hodiny';
            } else if (metric === 'srazky') {
                unit = ' mm';
                label = 'Sr√°≈æky:';
                description = 'Pr≈Ømƒõrn√© sr√°≈æky podle dne v roce a hodiny';
            }

            document.getElementById('heatmapMin').textContent = minValue.toFixed(1) + unit;
            document.getElementById('heatmapMax').textContent = maxValue.toFixed(1) + unit;
            document.getElementById('heatmapLegendLabel').textContent = label;
            document.getElementById('heatmapDescription').textContent = description;

            const gradientEl = document.getElementById('heatmapGradient');
            if (metric === 'teplota') {
                gradientEl.style.background = 'linear-gradient(to right, #1a2a4a, #3c5c8c, #6b9bc4, #a8cde3, #f5dc78, #faa04a, #e8583a, #c83028, #8b0000)';
            } else if (metric === 'vlhkost' || metric === 'srazky') {
                gradientEl.style.background = 'linear-gradient(to right, rgb(200, 220, 255), rgb(100, 150, 255), rgb(50, 100, 200), rgb(25, 40, 135))';
            } else if (metric === 'tlak') {
                gradientEl.style.background = 'linear-gradient(to right, rgb(240, 240, 240), rgb(180, 180, 180), rgb(100, 100, 100), rgb(50, 50, 50))';
            }

            const heatmapDiv = document.getElementById('heatmapGrid');
            heatmapDiv.innerHTML = '';

            const gridContainer = document.createElement('div');
            gridContainer.className = 'heatmap-grid';

            const yLabels = document.createElement('div');
            yLabels.className = 'heatmap-y-labels';
            
            for (let hour = 0; hour < 24; hour++) {
                const label = document.createElement('div');
                label.className = 'heatmap-y-label';
                label.textContent = hour + ':00';
                yLabels.appendChild(label);
            }
            gridContainer.appendChild(yLabels);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'heatmap-content-wrapper';

            const xLabels = document.createElement('div');
            xLabels.className = 'heatmap-x-labels';
            
            const monthNames = ['Led', '√öno', 'B≈ôe', 'Dub', 'Kvƒõ', 'ƒåvn', 'ƒåvc', 'Srp', 'Z√°≈ô', '≈ò√≠j', 'Lis', 'Pro'];
            const daysInMonth = [31, isLeapYear(selectedYear) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

            let cumulativeDays = 0;
            monthNames.forEach((month, idx) => {
                const monthLabel = document.createElement('div');
                monthLabel.className = 'heatmap-month-label';
                monthLabel.textContent = month;
                const position = ((cumulativeDays + daysInMonth[idx] / 2) / daysInYear) * 100;
                monthLabel.style.left = position + '%';
                xLabels.appendChild(monthLabel);
                cumulativeDays += daysInMonth[idx];
            });
            contentWrapper.appendChild(xLabels);

            const dataDiv = document.createElement('div');
            dataDiv.className = 'heatmap-data';

            avgMatrix.forEach((dayData, dayIndex) => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'heatmap-day-column';

                dayData.forEach((value, hour) => {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-hour-cell';

                    if (value !== null) {
                        cell.style.background = getColorForValue(value, minValue, maxValue, metric);
                        
                        const date = getDateFromDayOfYear(dayIndex, selectedYear);
                        cell.title = `${date.getDate()}. ${date.getMonth() + 1}. ${selectedYear} ${hour}:00 - ${value.toFixed(1)}${unit}`;
                    } else {
                        cell.style.background = '#e0e0e0';
                    }

                    dayColumn.appendChild(cell);
                });

                dataDiv.appendChild(dayColumn);
            });

            contentWrapper.appendChild(dataDiv);
            gridContainer.appendChild(contentWrapper);
            heatmapDiv.appendChild(gridContainer);
        }

        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        function getDayOfYear(date) {
            const tempDate = new Date(date.getTime());
            tempDate.setHours(12, 0, 0, 0);
            const start = new Date(tempDate.getFullYear(), 0, 1);
            const diff = tempDate - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function getDateFromDayOfYear(dayOfYear, year) {
            const date = new Date(year, 0, 1);
            date.setDate(date.getDate() + dayOfYear);
            return date;
        }

        function getColorForTemp(temp) {
            let r, g, b;
            
            if (temp < -5) {
                r = 26; g = 56; b = 83;
            } else if (temp < 0) {
                const ratio = (temp + 5) / 5;
                r = Math.round(26 + ratio * (91 - 26));
                g = Math.round(56 + ratio * (143 - 56));
                b = Math.round(83 + ratio * (185 - 83));
            } else if (temp < 5) {
                const ratio = temp / 5;
                r = Math.round(91 + ratio * (136 - 91));
                g = Math.round(143 + ratio * (197 - 143));
                b = Math.round(185 + ratio * (221 - 185));
            } else if (temp < 10) {
                const ratio = (temp - 5) / 5;
                r = Math.round(136 + ratio * (184 - 136));
                g = Math.round(197 + ratio * (224 - 197));
                b = Math.round(221 + ratio * (168 - 221));
            } else if (temp < 15) {
                const ratio = (temp - 10) / 5;
                r = Math.round(184 + ratio * (245 - 184));
                g = Math.round(224 + ratio * (232 - 224));
                b = Math.round(168 + ratio * (125 - 168));
            } else if (temp < 20) {
                const ratio = (temp - 15) / 5;
                r = Math.round(245 + ratio * (250 - 245));
                g = Math.round(232 + ratio * (172 - 232));
                b = Math.round(125 + ratio * (61 - 125));
            } else if (temp < 25) {
                const ratio = (temp - 20) / 5;
                r = Math.round(250 + ratio * (248 - 250));
                g = Math.round(172 + ratio * (92 - 172));
                b = Math.round(61 + ratio * (60 - 61));
            } else if (temp < 30) {
                const ratio = (temp - 25) / 5;
                r = Math.round(248 + ratio * (229 - 248));
                g = Math.round(92 + ratio * (53 - 92));
                b = Math.round(60 + ratio * (44 - 60));
            } else {
                r = 200; g = 16; b = 16;
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        function getColorForValue(value, minValue, maxValue, metric) {
            const ratio = (value - minValue) / (maxValue - minValue || 1);
            let r, g, b;
            
            if (metric === 'teplota') {
                return getColorForTemp(value);
            } else if (metric === 'vlhkost' || metric === 'srazky') {
                r = Math.round(200 - ratio * 175);
                g = Math.round(220 - ratio * 180);
                b = Math.round(255 - ratio * 120);
            } else if (metric === 'tlak') {
                const gray = Math.round(240 - ratio * 190);
                r = gray;
                g = gray;
                b = gray;
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        function initializeSliders() {
            const sliderNames = ['temp', 'humidity', 'pressure', 'battery', 'rain', 'rainBattery', 'all', 'quad'];
            
            sliderNames.forEach(name => {
                const sliderWindow = document.getElementById(`${name}SliderWindow`);
                const slider = document.getElementById(`${name}Slider`);
                
                if (!sliderWindow || !slider) return;
                
                sliders[name] = {
                    window: sliderWindow,
                    slider: slider,
                    isDragging: false,
                    isResizing: false,
                    resizeHandle: null,
                    startX: 0,
                    startLeft: 0,
                    startWidth: 0,
                    startRight: 0
                };

                sliderWindow.style.left = '0%';
                sliderWindow.style.width = '100%';
                sliderWindow.style.right = '';

                sliderWindow.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('chart-slider-handle')) return;
                    handleSliderMouseDown(e, name);
                });
                
                const leftHandle = sliderWindow.querySelector('.chart-slider-handle.left');
                const rightHandle = sliderWindow.querySelector('.chart-slider-handle.right');

                if (leftHandle) {
                    leftHandle.addEventListener('mousedown', (e) => handleResizeStart(e, name, 'left'));
                }
                
                if (rightHandle) {
                    rightHandle.addEventListener('mousedown', (e) => handleResizeStart(e, name, 'right'));
                }
            });

            document.addEventListener('mousemove', handleSliderMouseMove);
            document.addEventListener('mouseup', handleSliderMouseUp);
        }

        function handleSliderMouseDown(e, name) {
            const slider = sliders[name];
            if (!slider) return;
            
            slider.isDragging = true;
            slider.startX = e.clientX;
            
            const parentRect = slider.slider.getBoundingClientRect();
            const windowRect = slider.window.getBoundingClientRect();
            
            slider.startLeft = ((windowRect.left - parentRect.left) / parentRect.width) * 100;
            slider.startWidth = (windowRect.width / parentRect.width) * 100;
            
            e.preventDefault();
            e.stopPropagation();
        }

        function handleResizeStart(e, name, handle) {
            const slider = sliders[name];
            if (!slider) return;
            
            slider.isResizing = true;
            slider.resizeHandle = handle;
            slider.startX = e.clientX;
            
            const parentRect = slider.slider.getBoundingClientRect();
            const windowRect = slider.window.getBoundingClientRect();
            
            slider.startLeft = ((windowRect.left - parentRect.left) / parentRect.width) * 100;
            slider.startWidth = (windowRect.width / parentRect.width) * 100;
            slider.startRight = slider.startLeft + slider.startWidth;
            
            e.stopPropagation();
            e.preventDefault();
        }

        function handleSliderMouseMove(e) {
            let needsUpdate = false;
            let updateName = null;
            
            Object.keys(sliders).forEach(name => {
                const slider = sliders[name];
                if (!slider.isDragging && !slider.isResizing) return;

                const parentRect = slider.slider.getBoundingClientRect();
                const deltaX = e.clientX - slider.startX;
                const deltaPercent = (deltaX / parentRect.width) * 100;

                if (slider.isDragging) {
                    let newLeft = slider.startLeft + deltaPercent;
                    newLeft = Math.max(0, Math.min(100 - slider.startWidth, newLeft));
                    
                    slider.window.style.left = newLeft.toFixed(2) + '%';
                    slider.window.style.width = slider.startWidth.toFixed(2) + '%';
                    slider.window.style.right = '';
                    
                    needsUpdate = true;
                    updateName = name;
                } 
                else if (slider.isResizing) {
                    if (slider.resizeHandle === 'left') {
                        let newLeft = slider.startLeft + deltaPercent;
                        let newWidth = slider.startWidth - deltaPercent;
                        const minWidth = 5;
                        
                        if (newWidth < minWidth) {
                            newWidth = minWidth;
                            newLeft = slider.startRight - minWidth;
                        }
                        
                        newLeft = Math.max(0, newLeft);
                        
                        if (newLeft + newWidth > 100) {
                            newWidth = 100 - newLeft;
                        }
                        
                        slider.window.style.left = newLeft.toFixed(2) + '%';
                        slider.window.style.width = newWidth.toFixed(2) + '%';
                        slider.window.style.right = '';
                    } 
                    else if (slider.resizeHandle === 'right') {
                        let newWidth = slider.startWidth + deltaPercent;
                        const minWidth = 5;
                        newWidth = Math.max(minWidth, newWidth);
                        const maxWidth = 100 - slider.startLeft;
                        newWidth = Math.min(maxWidth, newWidth);
                        
                        slider.window.style.width = newWidth.toFixed(2) + '%';
                        slider.window.style.right = '';
                    }
                    
                    needsUpdate = true;
                    updateName = name;
                }
            });
            
            if (needsUpdate && updateName) {
                updateChartFromSlider(updateName);
            }
        }

        function handleSliderMouseUp() {
            Object.keys(sliders).forEach(name => {
                sliders[name].isDragging = false;
                sliders[name].isResizing = false;
                sliders[name].resizeHandle = null;
            });
        }

        function updateChartFromSlider(name) {
            if (!charts[name] || !currentData || !currentData.length) return;

            const slider = sliders[name];
            const parentRect = slider.slider.getBoundingClientRect();
            const windowRect = slider.window.getBoundingClientRect();

            const leftPercent = ((windowRect.left - parentRect.left) / parentRect.width) * 100;
            const widthPercent = (windowRect.width / parentRect.width) * 100;
            const rightPercent = leftPercent + widthPercent;

            const startIndex = Math.max(0, Math.floor((leftPercent / 100) * currentData.length));
            const endIndex = Math.min(currentData.length, Math.ceil((rightPercent / 100) * currentData.length));

            const sliderData = currentData.slice(startIndex, endIndex);

            if (sliderData.length === 0) return;

            const startDate = sliderData[0].datetime;
            const endDate = sliderData[sliderData.length - 1].datetime;

            const startLabel = document.getElementById(`${name}SliderStart`);
            const endLabel = document.getElementById(`${name}SliderEnd`);
            
            if (startLabel) {
                startLabel.textContent = startDate.toLocaleString('cs-CZ', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            if (endLabel) {
                endLabel.textContent = endDate.toLocaleString('cs-CZ', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            }

            updateSingleChart(name, sliderData);
        }

        function updateSingleChart(name, data) {
            if (name === 'temp' && charts.temp) {
                charts.temp.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.teplota }));
                if (data.length > 0) {
                    charts.temp.options.scales.x.min = data[0].datetime;
                    charts.temp.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.temp.update('none');
            } else if (name === 'humidity' && charts.humidity) {
                charts.humidity.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.vlhkost }));
                if (data.length > 0) {
                    charts.humidity.options.scales.x.min = data[0].datetime;
                    charts.humidity.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.humidity.update('none');
            } else if (name === 'pressure' && charts.pressure) {
                charts.pressure.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.tlak }));
                if (data.length > 0) {
                    charts.pressure.options.scales.x.min = data[0].datetime;
                    charts.pressure.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.pressure.update('none');
            } else if (name === 'battery' && charts.battery) {
                charts.battery.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.baterie }));
                if (data.length > 0) {
                    charts.battery.options.scales.x.min = data[0].datetime;
                    charts.battery.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.battery.update('none');
            } else if (name === 'rain' && charts.rain) {
                const dailyRainfall = calculateDailyRainfall(data);
                charts.rain.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.srazky }));
                charts.rain.data.datasets[1].data = dailyRainfall;
                if (data.length > 0) {
                    charts.rain.options.scales.x.min = data[0].datetime;
                    charts.rain.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.rain.update('none');
            } else if (name === 'rainBattery' && charts.rainBattery) {
                charts.rainBattery.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.baterieSrazkomeru }));
                if (data.length > 0) {
                    charts.rainBattery.options.scales.x.min = data[0].datetime;
                    charts.rainBattery.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.rainBattery.update('none');
            } else if (name === 'all' && charts.all) {
                charts.all.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.teplota }));
                charts.all.data.datasets[1].data = data.map(d => ({ x: d.datetime, y: d.vlhkost }));
                if (data.length > 0) {
                    charts.all.options.scales.x.min = data[0].datetime;
                    charts.all.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.all.update('none');
            } else if (name === 'quad' && charts.quad) {
                charts.quad.data.datasets[0].data = data.map(d => ({ x: d.datetime, y: d.teplota }));
                charts.quad.data.datasets[1].data = data.map(d => ({ x: d.datetime, y: d.vlhkost }));
                charts.quad.data.datasets[2].data = data.map(d => ({ x: d.datetime, y: d.tlak }));
                charts.quad.data.datasets[3].data = data.map(d => ({ x: d.datetime, y: d.baterie }));
                if (data.length > 0) {
                    charts.quad.options.scales.x.min = data[0].datetime;
                    charts.quad.options.scales.x.max = data[data.length - 1].datetime;
                }
                charts.quad.update('none');
            }
        }

        function drawSliderPreview(name, data) {
            const canvas = document.getElementById(`${name}SliderPreview`);
            if (!canvas || !data.length) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2;
            const height = canvas.height = canvas.offsetHeight * 2;
            
            ctx.clearRect(0, 0, width, height);

            let values;
            if (name === 'temp') values = data.map(d => d.teplota);
            else if (name === 'humidity') values = data.map(d => d.vlhkost);
            else if (name === 'pressure') values = data.map(d => d.tlak);
            else if (name === 'battery') values = data.map(d => d.baterie);
            else if (name === 'rain') values = data.map(d => d.srazky);
            else if (name === 'rainBattery') values = data.map(d => d.baterieSrazkomeru);
            else if (name === 'all') values = data.map(d => d.teplota);
            else if (name === 'quad') values = data.map(d => d.teplota);

            if (!values || values.length === 0) return;

            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1;

            ctx.beginPath();
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;

            values.forEach((val, i) => {
                const x = (i / (values.length - 1)) * width;
                const y = height - ((val - min) / range) * height * 0.8 - height * 0.1;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();
        }
    </script>
</body>
</html>
